<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Device - SmartHealth</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="bluetooth-container" style="max-width: 900px; margin: 2rem auto; padding: 2rem;">
        <div class="device-card" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
            <div class="connection-status" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; color: white; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="status-dot" id="statusDot" style="width: 20px; height: 20px; border-radius: 50%; background: #dc3545;"></div>
                    <div>
                        <h3 id="statusText">Not Connected</h3>
                        <p id="deviceName" style="margin: 0; opacity: 0.8;">No device paired</p>
                    </div>
                </div>
                <button id="disconnectBtn" style="display: none; padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 8px; color: white; cursor: pointer;">
                    Disconnect
                </button>
            </div>

            <div style="text-align: center;">
                <button class="btn-primary" id="connectBtn" style="padding: 1.5rem 3rem; font-size: 1.2rem; display: flex; align-items: center; gap: 1rem; margin: 2rem auto;">
                    ‚åö Connect Bluetooth Device
                </button>
                <p style="color: #666;">Click to search for nearby Bluetooth heart rate monitors</p>
            </div>

            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin: 2rem 0;">
                <h4>üì± Patient Information</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div>
                        <label>Patient ID:</label>
                        <input type="text" id="patientId" value="PATIENT_001" style="width: 100%; padding: 0.5rem; border-radius: 5px; border: 2px solid #e0e0e0;">
                    </div>
                    <div>
                        <label>Device ID:</label>
                        <input type="text" id="deviceId" value="BT_DEVICE_001" style="width: 100%; padding: 0.5rem; border-radius: 5px; border: 2px solid #e0e0e0;">
                    </div>
                </div>
            </div>
        </div>

        <div class="device-card" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
            <h2>üìä Live Vitals</h2>
            <div id="alertBox" style="padding: 1rem; border-radius: 10px; margin: 1rem 0; display: none;"></div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 2rem 0;">
                <div style="background: linear-gradient(135deg, #ff6b6b, #ff8e53); color: white; padding: 2rem; border-radius: 15px; text-align: center;">
                    <div style="font-size: 2rem;">‚ù§Ô∏è</div>
                    <div>Heart Rate</div>
                    <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;" id="heartRateDisplay">--</div>
                    <div>bpm</div>
                </div>

                <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 2rem; border-radius: 15px; text-align: center;">
                    <div style="font-size: 2rem;">‚ö°</div>
                    <div>Energy</div>
                    <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;" id="energyDisplay">--</div>
                    <div>kJ</div>
                </div>

                <div style="background: linear-gradient(135deg, #43e97b, #38f9d7); color: white; padding: 2rem; border-radius: 15px; text-align: center;">
                    <div style="font-size: 2rem;">üìä</div>
                    <div>RR Interval</div>
                    <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;" id="rrIntervalDisplay">--</div>
                    <div>ms</div>
                </div>
            </div>

            <div style="background: white; padding: 2rem; border-radius: 15px; margin: 2rem 0; height: 300px;">
                <h3>Heart Rate Trend</h3>
                <canvas id="heartRateChart"></canvas>
            </div>
        </div>

        <div class="device-card" style="background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
            <h3>üìã Activity Log</h3>
            <div id="dataLog" style="background: #1e1e1e; color: #00ff00; padding: 1rem; border-radius: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                <div>Waiting for device connection...</div>
            </div>
        </div>
    </div>

   <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDpF-98RgTGPOHy69Sm5sr6lt4WpPaGC40",
        authDomain: "smart-health-care-monito-d8ab0.firebaseapp.com",
        databaseURL: "https://smart-health-care-monito-d8ab0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "smart-health-care-monito-d8ab0",
        storageBucket: "smart-health-care-monito-d8ab0.firebasestorage.app",
        messagingSenderId: "592595862489",
        appId: "1:592595862489:web:0e1076762a5b9379760fc8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // üîí AUTHENTICATION REQUIRED
    auth.onAuthStateChanged((user) => {
        if (!user) {
            alert('üîí Please login to access Bluetooth Device Connection');
            window.location.href = 'login.html';
            return;
        }
        console.log('‚úÖ Authenticated:', user.email);
    });
        // Bluetooth configuration
        const HEART_RATE_SERVICE_UUID = 0x180D;
        const HEART_RATE_CHARACTERISTIC_UUID = 0x2A37;
        
        let bluetoothDevice = null;
        let heartRateCharacteristic = null;
        let heartRateChart = null;
        let heartRateData = [];
        let timeLabels = [];

        document.getElementById('connectBtn').addEventListener('click', connectToDevice);
        document.getElementById('disconnectBtn').addEventListener('click', disconnectDevice);

        async function connectToDevice() {
            try {
                addLog('üîç Searching for Bluetooth devices...');
                
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [HEART_RATE_SERVICE_UUID] }]
                });

                addLog(`‚úÖ Device found: ${bluetoothDevice.name}`);
                
                const server = await bluetoothDevice.gatt.connect();
                addLog('‚úÖ Connected! Getting heart rate service...');
                
                const heartRateService = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);
                heartRateCharacteristic = await heartRateService.getCharacteristic(HEART_RATE_CHARACTERISTIC_UUID);
                
                await heartRateCharacteristic.startNotifications();
                heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChange);
                
                updateConnectionStatus(true, bluetoothDevice.name);
                addLog('üíö Successfully connected and receiving data!');
                
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
            } catch (error) {
                console.error('Bluetooth Error:', error);
                addLog(`‚ùå Error: ${error.message}`);
                alert('Connection failed. Make sure Bluetooth is enabled and device is nearby.');
            }
        }

        function handleHeartRateChange(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            const rate16Bits = flags & 0x1;
            let heartRate;
            
            if (rate16Bits) {
                heartRate = value.getUint16(1, true);
            } else {
                heartRate = value.getUint8(1);
            }
            
            document.getElementById('heartRateDisplay').textContent = heartRate;
            checkHeartRateAlert(heartRate);
            updateChart(heartRate);
            sendDataToFirebase(heartRate);
            addLog(`üíì Heart Rate: ${heartRate} bpm`);
        }

        function checkHeartRateAlert(heartRate) {
            const alertBox = document.getElementById('alertBox');
            if (heartRate < 60) {
                alertBox.style.background = '#fff3cd';
                alertBox.style.borderLeft = '4px solid #ffc107';
                alertBox.textContent = `‚ö†Ô∏è Low heart rate detected: ${heartRate} bpm`;
                alertBox.style.display = 'block';
            } else if (heartRate > 100) {
                alertBox.style.background = '#f8d7da';
                alertBox.style.borderLeft = '4px solid #dc3545';
                alertBox.textContent = `üö® Elevated heart rate: ${heartRate} bpm`;
                alertBox.style.display = 'block';
            } else {
                alertBox.style.display = 'none';
            }
        }

        async function sendDataToFirebase(heartRate) {
            const deviceId = document.getElementById('deviceId').value;
            const patientId = document.getElementById('patientId').value;
            
            const dataPoint = {
                deviceId: deviceId,
                patientId: patientId,
                heartRate: heartRate,
                spo2: 98,
                temperature: 36.8,
                timestamp: Date.now(),
                source: 'bluetooth_' + (bluetoothDevice?.name || 'unknown')
            };
            
            try {
                await database.ref(`deviceData/${deviceId}`).push(dataPoint);
                await database.ref(`patients/${patientId}/latestData`).set(dataPoint);
            } catch (error) {
                console.error('Firebase Error:', error);
            }
        }

        function disconnectDevice() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                addLog('üîå Disconnected from device');
            }
        }

        function onDisconnected() {
            updateConnectionStatus(false, 'No device connected');
            addLog('‚ö†Ô∏è Device disconnected');
        }

        function updateConnectionStatus(connected, deviceName) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const deviceNameEl = document.getElementById('deviceName');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDot.style.background = '#28a745';
                statusDot.style.animation = 'pulse 2s infinite';
                statusText.textContent = 'Connected';
                deviceNameEl.textContent = deviceName;
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
            } else {
                statusDot.style.background = '#dc3545';
                statusDot.style.animation = 'none';
                statusText.textContent = 'Not Connected';
                deviceNameEl.textContent = deviceName;
                connectBtn.style.display = 'flex';
                disconnectBtn.style.display = 'none';
            }
        }

        function initializeChart() {
            const ctx = document.getElementById('heartRateChart').getContext('2d');
            heartRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Heart Rate (bpm)',
                        data: heartRateData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 40,
                            max: 160
                        }
                    }
                }
            });
        }

        function updateChart(heartRate) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            heartRateData.push(heartRate);
            timeLabels.push(timeLabel);
            
            if (heartRateData.length > 50) {
                heartRateData.shift();
                timeLabels.shift();
            }
            
            if (heartRateChart) {
                heartRateChart.update('none');
            }
        }

        function addLog(message) {
            const logContainer = document.getElementById('dataLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Initialize chart on load
        initializeChart();
    </script>
</body>
</html>
