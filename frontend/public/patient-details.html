<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Details - SmartHealth</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .back-btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .patient-header {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .patient-info h1 {
            color: #333;
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .info-item {
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item label {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .info-item strong {
            color: #333;
            font-size: 1rem;
        }

        .current-vitals {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 1.5rem;
            border-radius: 12px;
            color: white;
        }

        .current-vitals h3 {
            margin-bottom: 1rem;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .vital-box {
            background: rgba(255,255,255,0.2);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .vital-box .label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .vital-box .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .chart-card h3 {
            margin-bottom: 1.5rem;
            color: #333;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .history-table {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-normal {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }

        .export-btn {
            padding: 0.75rem 1.5rem;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .export-btn:hover {
            background: #218838;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>

        <div class="patient-header">
            <div class="patient-info">
                <h1 id="patientName">Loading...</h1>
                
                <div class="info-grid">
                    <div class="info-item">
                        <label>Patient ID</label>
                        <strong id="patientId">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Age</label>
                        <strong id="patientAge">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Gender</label>
                        <strong id="patientGender">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Blood Group</label>
                        <strong id="patientBlood">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Contact</label>
                        <strong id="patientContact">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Device ID</label>
                        <strong id="patientDevice">--</strong>
                    </div>
                </div>

                <div class="info-item" style="margin-top: 1rem;">
                    <label>Medical History</label>
                    <strong id="patientHistory">--</strong>
                </div>
            </div>

            <div class="current-vitals">
                <h3>Current Vitals</h3>
                <div class="vitals-grid">
                    <div class="vital-box">
                        <div class="label">Heart Rate</div>
                        <div class="value" id="currentHR">--</div>
                        <div class="label">bpm</div>
                    </div>
                    <div class="vital-box">
                        <div class="label">SpO2</div>
                        <div class="value" id="currentSpO2">--</div>
                        <div class="label">%</div>
                    </div>
                    <div class="vital-box">
                        <div class="label">Temperature</div>
                        <div class="value" id="currentTemp">--</div>
                        <div class="label">¬∞C</div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; opacity: 0.9;">
                    Last updated: <span id="lastUpdate">--</span>
                </p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="charts">üìä Charts</button>
            <button class="tab-btn" data-tab="history">üìã History</button>
            <button class="tab-btn" data-tab="medical">üè• Medical Records</button>
        </div>

        <div id="charts" class="tab-content active">
            <div class="chart-card">
                <h3>Heart Rate Trend (Last 24 Hours)</h3>
                <div class="chart-wrapper">
                    <canvas id="heartRateChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Blood Oxygen (SpO2) Trend</h3>
                <div class="chart-wrapper">
                    <canvas id="spo2Chart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>Temperature Trend</h3>
                <div class="chart-wrapper">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="history-table">
                <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>
                <h3>Vital Signs History</h3>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Heart Rate</th>
                            <th>SpO2</th>
                            <th>Temperature</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="5" class="no-data">Loading history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="medical" class="tab-content">
            <div class="chart-card">
                <h3>Medical Records</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Patient Name</label>
                        <strong id="medName">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Age</label>
                        <strong id="medAge">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Gender</label>
                        <strong id="medGender">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Blood Group</label>
                        <strong id="medBlood">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Contact</label>
                        <strong id="medContact">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <strong id="medEmail">--</strong>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <label>Address</label>
                        <strong id="medAddress">--</strong>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <label>Medical History</label>
                        <strong id="medMedHistory">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Registered On</label>
                        <strong id="medCreated">--</strong>
                    </div>
                    <div class="info-item">
                        <label>Device ID</label>
                        <strong id="medDevice">--</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpF-98RgTGPOHy69Sm5sr6lt4WpPaGC40",
            authDomain: "smart-health-care-monito-d8ab0.firebaseapp.com",
            databaseURL: "https://smart-health-care-monito-d8ab0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-health-care-monito-d8ab0",
            storageBucket: "smart-health-care-monito-d8ab0.firebasestorage.app",
            messagingSenderId: "592595862489",
            appId: "1:592595862489:web:0e1076762a5b9379760fc8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let patientId = null;
        let patientData = null;
        let historyData = [];
        let charts = {};

        // Auth check
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Get patient ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            patientId = urlParams.get('id');
            
            if (!patientId) {
                alert('No patient selected');
                window.location.href = 'dashboard.html';
                return;
            }
            
            loadPatientData();
            loadPatientHistory();
            initializeCharts();
        });

        // Load patient data
        async function loadPatientData() {
            const snapshot = await database.ref(`patients/${patientId}`).once('value');
            patientData = snapshot.val();
            
            if (!patientData) {
                alert('Patient not found');
                window.location.href = 'dashboard.html';
                return;
            }
            
            // Update UI
            document.getElementById('patientName').textContent = patientData.name;
            document.getElementById('patientId').textContent = patientId;
            document.getElementById('patientAge').textContent = patientData.age || 'N/A';
            document.getElementById('patientGender').textContent = patientData.gender || 'N/A';
            document.getElementById('patientBlood').textContent = patientData.bloodGroup || 'N/A';
            document.getElementById('patientContact').textContent = patientData.contact || 'N/A';
            document.getElementById('patientDevice').textContent = patientData.deviceId || 'N/A';
            document.getElementById('patientHistory').textContent = patientData.medicalHistory || 'None';
            
            // Medical records tab
            document.getElementById('medName').textContent = patientData.name;
            document.getElementById('medAge').textContent = patientData.age || 'N/A';
            document.getElementById('medGender').textContent = patientData.gender || 'N/A';
            document.getElementById('medBlood').textContent = patientData.bloodGroup || 'N/A';
            document.getElementById('medContact').textContent = patientData.contact || 'N/A';
            document.getElementById('medEmail').textContent = patientData.email || 'N/A';
            document.getElementById('medAddress').textContent = patientData.address || 'N/A';
            document.getElementById('medMedHistory').textContent = patientData.medicalHistory || 'None';
            document.getElementById('medCreated').textContent = new Date(patientData.createdAt).toLocaleDateString();
            document.getElementById('medDevice').textContent = patientData.deviceId || 'N/A';
            
            // Current vitals
            if (patientData.latestData) {
                document.getElementById('currentHR').textContent = patientData.latestData.heartRate || '--';
                document.getElementById('currentSpO2').textContent = patientData.latestData.spo2 || '--';
                document.getElementById('currentTemp').textContent = patientData.latestData.temperature || '--';
                document.getElementById('lastUpdate').textContent = new Date(patientData.latestData.timestamp).toLocaleString();
            }
        }

        // Load patient history
        async function loadPatientHistory() {
            const deviceId = patientData.deviceId;
            const snapshot = await database.ref(`deviceData/${deviceId}`).limitToLast(100).once('value');
            const data = snapshot.val();
            
            if (!data) {
                document.getElementById('historyBody').innerHTML = '<tr><td colspan="5" class="no-data">No history data available</td></tr>';
                return;
            }
            
            historyData = Object.entries(data).map(([key, value]) => ({
                id: key,
                ...value
            })).sort((a, b) => b.timestamp - a.timestamp);
            
            updateHistoryTable();
            updateCharts();
        }

        // Update history table
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            historyData.forEach(record => {
                const row = document.createElement('tr');
                
                const hrStatus = record.heartRate > 100 || record.heartRate < 60 ? 'critical' : 
                                 record.heartRate > 90 || record.heartRate < 70 ? 'warning' : 'normal';
                const spo2Status = record.spo2 < 90 ? 'critical' : record.spo2 < 95 ? 'warning' : 'normal';
                const tempStatus = record.temperature > 37.5 || record.temperature < 36 ? 'warning' : 'normal';
                
                const overallStatus = hrStatus === 'critical' || spo2Status === 'critical' || tempStatus === 'critical' ? 'critical' :
                                     hrStatus === 'warning' || spo2Status === 'warning' || tempStatus === 'warning' ? 'warning' : 'normal';
                
                row.innerHTML = `
                    <td>${new Date(record.timestamp).toLocaleString()}</td>
                    <td>${record.heartRate} bpm</td>
                    <td>${record.spo2}%</td>
                    <td>${record.temperature}¬∞C</td>
                    <td><span class="status-badge status-${overallStatus}">${overallStatus.toUpperCase()}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize charts
        function initializeCharts() {
            const ctxHR = document.getElementById('heartRateChart').getContext('2d');
            charts.heartRate = new Chart(ctxHR, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Heart Rate (bpm)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 50, max: 150 }
                    }
                }
            });

            const ctxSpO2 = document.getElementById('spo2Chart').getContext('2d');
            charts.spo2 = new Chart(ctxSpO2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'SpO2 (%)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 85, max: 100 }
                    }
                }
            });

            const ctxTemp = document.getElementById('tempChart').getContext('2d');
            charts.temp = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 35, max: 40 }
                    }
                }
            });
        }

        // Update charts
        function updateCharts() {
            const last24Hours = historyData.slice(0, 50).reverse();
            
            const labels = last24Hours.map(d => new Date(d.timestamp).toLocaleTimeString());
            const hrData = last24Hours.map(d => d.heartRate);
            const spo2Data = last24Hours.map(d => d.spo2);
            const tempData = last24Hours.map(d => d.temperature);
            
            charts.heartRate.data.labels = labels;
            charts.heartRate.data.datasets[0].data = hrData;
            charts.heartRate.update();
            
            charts.spo2.data.labels = labels;
            charts.spo2.data.datasets[0].data = spo2Data;
            charts.spo2.update();
            
            charts.temp.data.labels = labels;
            charts.temp.data.datasets[0].data = tempData;
            charts.temp.update();
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Export to CSV
        function exportToCSV() {
            let csv = 'Date & Time,Heart Rate (bpm),SpO2 (%),Temperature (¬∞C),Status\n';
            
            historyData.forEach(record => {
                const hrStatus = record.heartRate > 100 || record.heartRate < 60 ? 'CRITICAL' : 
                                 record.heartRate > 90 || record.heartRate < 70 ? 'WARNING' : 'NORMAL';
                const spo2Status = record.spo2 < 90 ? 'CRITICAL' : record.spo2 < 95 ? 'WARNING' : 'NORMAL';
                const overallStatus = hrStatus === 'CRITICAL' || spo2Status === 'CRITICAL' ? 'CRITICAL' :
                                     hrStatus === 'WARNING' || spo2Status === 'WARNING' ? 'WARNING' : 'NORMAL';
                
                csv += `"${new Date(record.timestamp).toLocaleString()}",${record.heartRate},${record.spo2},${record.temperature},${overallStatus}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `patient_${patientId}_history_${Date.now()}.csv`;
            a.click();
        }
    </script>
</body>
</html>
